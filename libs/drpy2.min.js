import cheerio from"assets://js/lib/cheerio.min.js";import"assets://js/lib/crypto-js.js";import"./jsencrypt.js";import"./node-rsa.js";import"./pako.min.js";import 模板 from"./模板.js";import{gbkTool}from"./gbk.js";import"./json5.js";import"./jinja.js";const _jinja2=cheerio.jinja2;cheerio.jinja2=function(t,r){try{return jinja.render(t,r)}catch(e){console.log("新的jinja2库渲染失败,换回原始cheerio:"+e.message);return _jinja2(t,r)}};let vercode=typeof pdfl==="function"?"drpy2.1":"drpy2";const VERSION=vercode+" 3.9.51beta6 20241220";const UpdateInfo=[{date:"20241220",title:"drpy更新，优化去广告算法",version:"3.9.51beta6 20241220",msg:`
 1. 更新同步drpyS里的去广告算法
       `},{date:"20241104",title:"drpy更新，增加新特性",version:"3.9.51beta5 20241104",msg:`
 1. rule增加 搜索验证标识 属性,可以不定义，默认为 '系统安全验证|请输入验证码' 
 2. rule增加 searchNoPage 属性，可以不定义，如果定义 1 将关闭该源的搜索翻页功能，超过1页直接返回空     
       `}];function getUpdateInfo(){return UpdateInfo.map(e=>{e.msg=e.msg.trim().split("\n").map(e=>e.trim()).join("\n");return e})}function init_test(){console.log("init_test_start");console.log("当前版本号:"+VERSION);console.log("本地代理地址:"+getProxyUrl());console.log(RKEY);console.log(JSON.stringify(rule));console.log("init_test_end")}function ocr_demo_test(){let e=`iVBORw0KGgoAAAANSUhEUgAAAIAAAAAoBAMAAADEX+97AAAAG1BMVEXz+/4thQTa7N6QwIFFkyNeokKozqDB3b93sWHFR+MEAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABN0lEQVRIie2TQU+DQBCFt9vScvQpxR4xrcSjJCZ67JDGXsX+AdR4B3vpsSYm/m2HXaRLmuySepR3Gdidb/btDAjRq5dT96eCMlfBuzi1QLZUoZy2yz5sOvI+9iomaPEZ6nWnEtxqIyiM1RcAy44GNDhBXUjot/VVNweV1ah68FqWRyjKIOqAcyYF6rGcmpYnHzGt3fycNoMw0d3/THFu7hFSJ/8OXO6iTM8/KSg09obAzIHLO250LgQ0txOZSfgrV4Exdw98uGycJ0ErAeExZGhOmFHV9zHO6qVSj0MpLq7xZON56o++MjlsEgfVhbQWWME+xQX7J4V6zfi9A1Ly9rP1BvEXp+BbVJ/M77n+wfOIDVp51pZ4iBxvmj9AGrtvry6emwfKnVkW+ZRKd5ZNMvob36vXP9YPDmQki8QiCFAAAAAASUVORK5CYII=`;OcrApi.api=OCR_API;let t=OcrApi.classification(e);log("测试验证码图片的ocr识别结果为:"+t)}function rsa_demo_test(){let e=(new Date).getTime();let t=`
-----BEGIN RSA PUBLIC KEY-----
MEgCQQCrI0pQ/ERRpJ3Ou190XJedFq846nDYP52rOtXyDxlFK5D3p6JJu2RwsKwy
lsQ9xY0xYPpRZUZKMEeR7e9gmRNLAgMBAAE=
-----END RSA PUBLIC KEY-----
`.trim();let r=`
MEgCQQCrI0pQ/ERRpJ3Ou190XJedFq846nDYP52rOtXyDxlFK5D3p6JJu2RwsKwy
lsQ9xY0xYPpRZUZKMEeR7e9gmRNLAgMBAAE=
`.trim();let l=`
-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKsjSlD8RFGknc67X3Rcl50WrzjqcNg/
nas61fIPGUUrkPenokm7ZHCwrDKWxD3FjTFg+lFlRkowR5Ht72CZE0sCAwEAAQ==
-----END PUBLIC KEY-----`.trim();let i=`
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAKsjSlD8RFGknc67X3Rcl50WrzjqcNg/
nas61fIPGUUrkPenokm7ZHCwrDKWxD3FjTFg+lFlRkowR5Ht72CZE0sCAwEAAQ==
`.trim();let o=`
-----BEGIN RSA PRIVATE KEY-----
MIIBOAIBAAJBAKsjSlD8RFGknc67X3Rcl50WrzjqcNg/nas61fIPGUUrkPenokm7
ZHCwrDKWxD3FjTFg+lFlRkowR5Ht72CZE0sCAwEAAQI/b6OV1z65UokQaMvSeRXt
0Yv6wiYtduQI9qpq5nzy/ytaqsbBfClNTi/HifKPKxlRouWFkc518EQI8LBxoarJ
AiEA4DaONMplV8PQNa3TKn2F+SDEvLOCjdL0kHKdN90Ti28CIQDDZnTBaHgZwZbA
hS7Bbf5yvwjWMhO6Y7l04/Qm7R+35QIgPuQuqXIoUSD080mp1N5WyRW++atksIF+
5lGv9e6GP/MCICnj8y/rl6Pd7tXDN6zcSeqLrfdNsREKhB3dKOCXgW9JAiAFYtFS
EJNBXVRTK42SNsZ2hJ/9xLwOwnH2epT8Q43s3Q==
-----END RSA PRIVATE KEY-----
`.trim();let s=`
-----BEGIN PRIVATE KEY-----
MIIBUgIBADANBgkqhkiG9w0BAQEFAASCATwwggE4AgEAAkEAqyNKUPxEUaSdzrtf
dFyXnRavOOpw2D+dqzrV8g8ZRSuQ96eiSbtkcLCsMpbEPcWNMWD6UWVGSjBHke3v
YJkTSwIDAQABAj9vo5XXPrlSiRBoy9J5Fe3Ri/rCJi125Aj2qmrmfPL/K1qqxsF8
KU1OL8eJ8o8rGVGi5YWRznXwRAjwsHGhqskCIQDgNo40ymVXw9A1rdMqfYX5IMS8
s4KN0vSQcp033ROLbwIhAMNmdMFoeBnBlsCFLsFt/nK/CNYyE7pjuXTj9CbtH7fl
AiA+5C6pcihRIPTzSanU3lbJFb75q2SwgX7mUa/17oY/8wIgKePzL+uXo93u1cM3
rNxJ6out902xEQqEHd0o4JeBb0kCIAVi0VIQk0FdVFMrjZI2xnaEn/3EvA7CcfZ6
lPxDjezd
-----END PRIVATE KEY-----
`.trim();let n=`
NodeRsa
这是node-rsa 现在修改集成在drpy里使用`.trim();let a=NODERSA.encryptRSAWithPublicKey(n,t,{outputEncoding:"base64",options:{environment:"browser",encryptionScheme:"pkcs1_oaep"}});console.log("公钥加密");console.log(a);let p=NODERSA.decryptRSAWithPrivateKey(a,o,{options:{environment:"browser",encryptionScheme:"pkcs1_oaep"}});console.log("私钥解密");console.log(p);let c=NODERSA.sign("1",o,{outputEncoding:"base64",options:{environment:"browser",encryptionScheme:"pkcs1",signingScheme:"pkcs1-sha256"}});console.log("pkcs1_sha256_sign");console.log(c);let u=NODERSA.verify("1","Oulx2QrgeipKYBtqEDqFb2s/+ndk2cGQxO4CkhU7iBM1vyNmmvqubpsmeoUuN3waGrYZLknSEdwBkfv0tUMpFQ==",o,{options:{environment:"browser",encryptionScheme:"pkcs1",signingScheme:"pkcs1-sha256"}});console.log("pkcs1_sha256_sign_verify");console.log(u);let f=NODERSA.encryptRSAWithPublicKey(n,`-----BEGIN RSA PUBLIC KEY-----
MIIBCgKCAQEA5KOq1gRNyllLNWKQy8sGpZE3Q1ULLSmzZw+eaAhj9lvqn7IsT1du
SYn08FfoOA2qMwtz+1O2l1mgzNoSVCyVpVabnTG+C9XKeZXAnJHd8aYA7l7Sxhdm
kte+iymYZ0ZBPzijo8938iugtVvqi9UgDmnY3u/NlQDqiL5BGqSxSTd/Sgmy3zD8
PYzEa3wD9vehQ5fZZ45vKIq8GNVh2Z8+IGO85FF1OsN7+b2yGJa/FmDDNn0+HP+m
PfI+kYBqEVpo0Ztbc3UdxgFwGC8O1n8AQyriwHnSOtIiuBH62J/7qyC/3LEAApRb
Dd9YszqzmODjQUddZKHmvc638VW+azc0EwIDAQAB
-----END RSA PUBLIC KEY-----
`,{outputEncoding:"base64",options:{environment:"browser",encryptionScheme:{scheme:"pkcs1_oaep",hash:"sha256"}}});console.log("pkcs1_oaep_sha256");console.log(f);p=NODERSA.decryptRSAWithPrivateKey("kSZesAAyYh2hdsQnYMdGqb6gKAzTauBKouvBzWcc4+F8RvGd0nwO6mVkUMVilPgUuNxjEauHayHiY8gI3Py45UI3+km0rSGyHrS6dHiHgCkMejXHieglYzAB0IxX3Jkm4z/66bdB/D+GFy0oct5fGCMI1UHPjEAYOsazJDa8lBFNbjiWFeb/qiZtIx3vGM7KYPAZzyRf/zPbbQ8zy9xOmRuOl5nnIxgo0Okp3KO/RIPO4GZOSBA8f2lx1UtNwwrXAMpcNavtoqHVcjJ/9lcotXYQFrn5b299pSIRf2gVm8ZJ31SK6Z8cc14nKtvgnmsgClDzIXJ1o1RcDK+knVAySg==",`-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA5KOq1gRNyllLNWKQy8sGpZE3Q1ULLSmzZw+eaAhj9lvqn7Is
T1duSYn08FfoOA2qMwtz+1O2l1mgzNoSVCyVpVabnTG+C9XKeZXAnJHd8aYA7l7S
xhdmkte+iymYZ0ZBPzijo8938iugtVvqi9UgDmnY3u/NlQDqiL5BGqSxSTd/Sgmy
3zD8PYzEa3wD9vehQ5fZZ45vKIq8GNVh2Z8+IGO85FF1OsN7+b2yGJa/FmDDNn0+
HP+mPfI+kYBqEVpo0Ztbc3UdxgFwGC8O1n8AQyriwHnSOtIiuBH62J/7qyC/3LEA
ApRbDd9YszqzmODjQUddZKHmvc638VW+azc0EwIDAQABAoIBADZ/QGgUzInvsLp/
zO2WbfYm39o/uhNAvk9RbLt1TIZbMFhyOpeKynHi3Swwd9xsfWX/U9zS/lGi/m31
iKrhmaW4OA1G3vqpMcK7TBbFufYwUEaA+ZJX344euH8pIfdzyneMQ4z3Far2dS7l
QsmjuilVV2kEFadveXewiYoVOWCu00w6bN8wy2SIHlQn+kIL6HQhWz12iKKflIKu
eGRdzLHsKmBt6WbY1Wuhx7HU0fAKdlBDPxCHNlI+kybUYE9o5C2vJiaVM5wqJBgZ
8Dz8kt1QbLJ910JoLXkLVQ8uC8NJKQwFtqQjTGPnEq0+wbgz6Ij599rKZkwW/xq9
l6KoUiECgYEA6Ah42tVdkNW047f03xVYXFH96RgorHRS36mR8Y+ONUq1fwKidovC
WjwVujt4OPf3l1W6iyn/F6cu/bsmvPrSc3HTN0B1V31QK4OjgetxQ2PSbTldH02J
NPzkt+v+cPxXpx/P5mgt7Weefw5txU547KubGrHUV5rBKFtIx9pj16MCgYEA/EF0
o19+D24DZAPwlDS5VbEd7FStnwY4oQ5PqbuNOSbSJLMWU0AqzXcRokp8UTyCZ0X3
ATkS1REq97kShCuR+npTR6a6DlY7sdpPI1SMLNajgB2tkx0EOzX+PfNIbHUd4jpJ
I0ZMAHv/OOtkzQHDaeTWBTrzsWm6/nTiykfduNECgYEA46AMD4HpPECqKAs66e5i
tI6q7JSKskObWVdcmQEfnSAhVOwcvPb2Ptda6UuV8S0xcwDi88rLOUUFUFzc79+P
vTkY38cYVi/VChsluDpk7ptqv0PbGu5Rf+3n4pZdEjI7OvR2W64wAAn67uIUxc7p
yiO/ET0K9rYWb6S9jXGtKMkCgYEA2kPAqoO7zZoBMQ7/oR0lp/HC1HRIbiqx4RlC
8Lgpb+QZPEwA6zPAVVvLVENi4d+bbcRp/xLlKpraNNJcJSSWAMbLPFoU7sbKjA87
HnTPfRSTEA2d3Ibk3F7Rh8TzS3Ti0JZiJjVzGZAwu41iAMifzwaD8K6boUy80eNN
QH2CaaECgYBUsLYvC/MiYg3w+LGOONuQongoVUXjGqnw2bjVa9RK7lwRdXPUqJ51
MpVO98IkoLvGSI/0sGNP3GKNhC+eMGjJAVwFyEuOn+JsmMv9Y9uStIVi5tIHIhKw
m7mp8il0kaftHdSxTbspG3tZ2fjIiFIZkLEOmRpd7ogWumgOajzUdA==
-----END RSA PRIVATE KEY-----`,{options:{environment:"browser",encryptionScheme:"pkcs1_oaep"}});console.log("decryptedWithPrivate");console.log(p);(()=>{let e=new NODERSA.NodeRSA({b:1024});e.setOptions({encryptionScheme:"pkcs1"});let t=`你好drpy node-ras`;let r=e.encrypt(t,"base64");console.log("encrypted: ",r);const l=e.decrypt(r,"utf8");console.log("decrypted: ",l)})();let d=(new Date).getTime();console.log("rsa_demo_test 测试耗时:"+(d-e)+"毫秒")}function pre(){if(typeof rule.预处理==="string"&&rule.预处理&&rule.预处理.trim()){let code=rule.预处理.trim();console.log("执行预处理代码:"+code);if(code.startsWith("js:")){code=code.replace("js:","")}try{eval(code)}catch(e){console.log(`预处理执行失败:${e.message}`)}}}let rule={};const MOBILE_UA="Mozilla/5.0 (Linux; Android 11; Pixel 5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.91 Mobile Safari/537.36";const PC_UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36";const UA="Mozilla/5.0";const UC_UA="Mozilla/5.0 (Linux; U; Android 9; zh-CN; MI 9 Build/PKQ1.181121.001) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/57.0.2987.108 UCBrowser/12.5.5.1035 Mobile Safari/537.36";const IOS_UA="Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1";const RULE_CK="cookie";const CATE_EXCLUDE="首页|留言|APP|下载|资讯|新闻|动态";const TAB_EXCLUDE="猜你|喜欢|下载|剧情|榜|评论";const OCR_RETRY=3;const OCR_API="https://api.nn.ci/ocr/b64/text";if(typeof MY_URL==="undefined"){var MY_URL}var HOST;var RKEY;var fetch;var print;var log;var rule_fetch_params;var fetch_params;var oheaders;var _pdfh;var _pdfa;var _pd;const DOM_CHECK_ATTR=/(url|src|href|-original|-src|-play|-url|style)$/;const SPECIAL_URL=/^(ftp|magnet|thunder|ws):/;const NOADD_INDEX=/:eq|:lt|:gt|:first|:last|^body$|^#/;const URLJOIN_ATTR=/(url|src|href|-original|-src|-play|-url|style)$|^(data-|url-|src-)/;const SELECT_REGEX=/:eq|:lt|:gt|#/g;const SELECT_REGEX_A=/:eq|:lt|:gt/g;const $js={toString(e){let t=e.toString();return t.replace(/^\(\)(\s+)?=>(\s+)?\{/,"js:").replace(/\}$/,"")}};function window_b64(){let n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let a=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);function e(e){var t,r,l;var i,o,s;l=e.length;r=0;t="";while(r<l){i=e.charCodeAt(r++)&255;if(r==l){t+=n.charAt(i>>2);t+=n.charAt((i&3)<<4);t+="==";break}o=e.charCodeAt(r++);if(r==l){t+=n.charAt(i>>2);t+=n.charAt((i&3)<<4|(o&240)>>4);t+=n.charAt((o&15)<<2);t+="=";break}s=e.charCodeAt(r++);t+=n.charAt(i>>2);t+=n.charAt((i&3)<<4|(o&240)>>4);t+=n.charAt((o&15)<<2|(s&192)>>6);t+=n.charAt(s&63)}return t}function t(e){var t,r,l,i;var o,s,n;s=e.length;o=0;n="";while(o<s){do{t=a[e.charCodeAt(o++)&255]}while(o<s&&t==-1);if(t==-1)break;do{r=a[e.charCodeAt(o++)&255]}while(o<s&&r==-1);if(r==-1)break;n+=String.fromCharCode(t<<2|(r&48)>>4);do{l=e.charCodeAt(o++)&255;if(l==61)return n;l=a[l]}while(o<s&&l==-1);if(l==-1)break;n+=String.fromCharCode((r&15)<<4|(l&60)>>2);do{i=e.charCodeAt(o++)&255;if(i==61)return n;i=a[i]}while(o<s&&i==-1);if(i==-1)break;n+=String.fromCharCode((l&3)<<6|i)}return n}return{atob:t,btoa:e}}if(typeof atob!=="function"||typeof btoa!=="function"){var{atob,btoa}=window_b64()}if(typeof Object.assign!=="function"){Object.assign=function(){let r=arguments[0];for(let e=1;e<arguments.length;e++){let t=arguments[e];for(let e in t){if(Object.prototype.hasOwnProperty.call(t,e)){r[e]=t[e]}}}return r}}if(!String.prototype.includes){String.prototype.includes=function(e,t){if(typeof t!=="number"){t=0}if(t+e.length>this.length){return false}else{return this.indexOf(e,t)!==-1}}}if(!Array.prototype.includes){Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(this==null){throw new TypeError('"this" is null or not defined')}var r=Object(this);var l=r.length>>>0;if(l===0){return false}var i=t|0;var o=Math.max(i>=0?i:l-Math.abs(i),0);while(o<l){if(r[o]===e){return true}o++}return false},enumerable:false})}if(typeof String.prototype.startsWith!=="function"){String.prototype.startsWith=function(e){return this.slice(0,e.length)===e}}if(typeof String.prototype.endsWith!=="function"){String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1}}Object.defineProperty(Object.prototype,"myValues",{value:function(e){if(e==null){throw new TypeError("Cannot convert undefined or null to object")}var t=[];for(var r in e){if(e.hasOwnProperty(r)){t.push(e[r])}}return t},enumerable:false});if(typeof Object.prototype.values!=="function"){Object.defineProperty(Object.prototype,"values",{value:function(e){if(e==null){throw new TypeError("Cannot convert undefined or null to object")}var t=[];for(var r in e){if(e.hasOwnProperty(r)){t.push(e[r])}}return t},enumerable:false})}if(typeof Array.prototype.join!=="function"){Object.defineProperty(Array.prototype,"join",{value:function(e){e=e||"";let t=this;let r="";let l=0;if(!Array.isArray(t)){throw String(t)+"is not Array"}if(t.length===0){return""}if(t.length===1){return String(t[0])}l=1;r=this[0];for(;l<t.length;l++){r+=String(e)+String(t[l])}return r},enumerable:false})}if(typeof Array.prototype.toReversed!=="function"){Object.defineProperty(Array.prototype,"toReversed",{value:function(){const e=this.slice();const t=e.reverse();return t},enumerable:false})}Object.defineProperty(Array.prototype,"append",{value:Array.prototype.push,enumerable:false});Object.defineProperty(String.prototype,"strip",{value:String.prototype.trim,enumerable:false});Object.defineProperty(String.prototype,"rstrip",{value:function(e){let t=new RegExp(e+"$");return this.replace(t,"")},enumerable:false});function 是否正版(e){let t=new RegExp("qq.com|iqiyi.com|youku.com|mgtv.com|bilibili.com|sohu.com|ixigua.com|pptv.com|miguvideo.com|le.com|1905.com|fun.tv");return t.test(e)}function urlDeal(e){if(!e){return""}if(!是否正版(e)){return e}if(!/miguvideo/.test(e)){e=e.split("#")[0].split("?")[0]}return e}function setResult(e){if(!Array.isArray(e)){return[]}VODS=[];e.forEach(function(e){let t={vod_id:e.url||"",vod_name:e.title||"",vod_remarks:e.desc||"",vod_content:e.content||"",vod_pic:e.pic_url||e.img||""};let r=Object.keys(e);if(r.includes("tname")){t.type_name=e.tname||""}if(r.includes("tid")){t.type_id=e.tid||""}if(r.includes("year")){t.vod_year=e.year||""}if(r.includes("actor")){t.vod_actor=e.actor||""}if(r.includes("director")){t.vod_director=e.director||""}if(r.includes("area")){t.vod_area=e.area||""}VODS.push(t)});return VODS}function setResult2(e){VODS=e.list||[];return VODS}function setHomeResult(e){if(!e||typeof e!=="object"){return[]}return setResult(e.list)}function rc(e){if(e==="maomi_aes.js"){var r=CryptoJS.enc.Utf8.parse("625222f9149e961d");var l=CryptoJS.enc.Utf8.parse("5efdtf6060e2o330");return{De:function(e){e=CryptoJS.enc.Hex.parse(e);return CryptoJS.AES.decrypt(CryptoJS.enc.Base64.stringify(e),r,{iv:l,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)},En:function(e){var t=CryptoJS.AES.encrypt(e,r,{iv:l,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return t.ciphertext.toString()}}}return{}}function maoss(jxurl,ref,key){fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));eval(getCryptoJS());try{var getVideoInfo=function(e){return CryptoJS.AES.decrypt(e,key,{iv:iv,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)};var token_key=key==undefined?"dvyYRQlnPRCMdQSe":key;if(ref){var html=request(jxurl,{headers:{Referer:ref}})}else{var html=request(jxurl)}if(html.indexOf("&btwaf=")!=-1){html=request(jxurl+"&btwaf"+html.match(/&btwaf(.*?)"/)[1],{headers:{Referer:ref}})}var token_iv=html.split('_token = "')[1].split('"')[0];var key=CryptoJS.enc.Utf8.parse(token_key);var iv=CryptoJS.enc.Utf8.parse(token_iv);eval(html.match(/var config = {[\s\S]*?}/)[0]+"");if(!config.url.startsWith("http")){config.url=CryptoJS.AES.decrypt(config.url,key,{iv:iv,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)}return config.url}catch(e){return""}}function urlencode(e){e=(e+"").toString();return encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}function encodeUrl(e){if(typeof encodeURI=="function"){return encodeURI(e)}else{e=(e+"").toString();return encodeURIComponent(e).replace(/%2F/g,"/").replace(/%3F/g,"?").replace(/%3A/g,":").replace(/%40/g,"@").replace(/%3D/g,"=").replace(/%3A/g,":").replace(/%2C/g,",").replace(/%2B/g,"+").replace(/%24/g,"$")}}function base64Encode(e){return CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(e))}function base64Decode(e){return CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64.parse(e))}function md5(e){return CryptoJS.MD5(e).toString()}function uint8ArrayToBase64(e){let t=String.fromCharCode.apply(null,Array.from(e));return btoa(t)}function Utf8ArrayToStr(e){var t,r,l,i;var o,s;t="";l=e.length;r=0;while(r<l){i=e[r++];switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(i);break;case 12:case 13:o=e[r++];t+=String.fromCharCode((i&31)<<6|o&63);break;case 14:o=e[r++];s=e[r++];t+=String.fromCharCode((i&15)<<12|(o&63)<<6|(s&63)<<0);break}}return t}function gzip(e){let t=pako.gzip(e,{});return uint8ArrayToBase64(t)}function ungzip(e){let t=atob(e);const r=t.split("").map(function(e){return e.charCodeAt(0)});const l=new Uint8Array(r);const i=pako.inflate(l);return Utf8ArrayToStr(i)}function encodeStr(e,t){t=t||"gbk";if(t.startsWith("gb")){const r=gbkTool();e=r.encode(e)}return e}function decodeStr(e,t){t=t||"gbk";if(t.startsWith("gb")){const r=gbkTool();e=r.decode(e)}return e}function getCryptoJS(){return'console.log("CryptoJS已装载");'}const RSA={decode:function(l,i,o){o=o||{};if(typeof JSEncrypt==="function"){let e=o.chunkSize||117;let t=this.getPrivateKey(i);const s=new JSEncrypt;s.setPrivateKey(t);let r="";r=s.decryptUnicodeLong(l);return r}else{return false}},encode:function(l,i,o){o=o||{};if(typeof JSEncrypt==="function"){let e=o.chunkSize||117;let t=this.getPublicKey(i);const s=new JSEncrypt;s.setPublicKey(t);let r="";r=s.encryptUnicodeLong(l);return r}else{return false}},fixKey(e,t,r){if(!e.includes(t)){e=t+e}if(!e.includes(r)){e+=r}return e},getPrivateKey(e){let t="-----BEGIN RSA PRIVATE KEY-----";let r="-----END RSA PRIVATE KEY-----";return this.fixKey(e,t,r)},getPublicKey(e){let t="-----BEGIN PUBLIC KEY-----";let r="-----END PUBLIC KEY-----";return this.fixKey(e,t,r)}};function getProxyUrl(){if(typeof getProxy==="function"){return getProxy(true)}else{return"http://127.0.0.1:9978/proxy?do=js"}}function fixAdM3u8(e,r,l){if(!e&&!r||!e&&r&&!r.startsWith("http")){return""}if(!e){log("m3u8_url:"+r);e=request(r)}log("len(m3u8_text):"+e.length);if(!l){return e}if(l.startsWith("reg:")){l=l.slice(4)}else if(l.startsWith("js:")){l=l.slice(3)}let t=e.slice(0,e.indexOf("#EXTINF")).trim();let i=e.slice(e.indexOf("#EXTINF"),e.indexOf("#EXT-X-ENDLIST")).trim();let o=e.slice(e.indexOf("#EXT-X-ENDLIST")).trim();let s=[];let n=i.split("\n");let a=n.length;let p=0;while(p<a){let t=n[p];let r=n[p+1];if(t.startsWith("#EXTINF")){s.push([t,r].join("&"));p+=2}else if(t.startsWith("#EXT-X-DISCONTINUITY")){let e=n[p+2];s.push([t,r,e].join("&"));p+=3}else{break}}let c=[];for(let t of s){if(l&&new RegExp(l).test(t)){}else{let e=t.split("&");if(!e[e.length-1].startsWith("http")&&r.startsWith("http")){e[e.length-1]=urljoin(r,e[e.length-1])}e.forEach(e=>{c.push(e)})}}c=c.join("\n").trim();e=[t,c,o].join("\n").trim();return e}function fixAdM3u8Ai(r,e){let t=(new Date).getTime();let l=e?{headers:e}:{};function i(e,t){let r=0;while(r<e.length){if(e[r]!==t[r]){break}r++}return r}function o(e){return e.split("").reverse().join("")}let s=request(r,l).content;s=s.trim().split("\n").map(e=>e.startsWith("#")?e:urljoin(r,e)).join("\n");s=s.replace(/\n\n/gi,"\n");let n=s.split("\n").slice(-1)[0];if(n.length<5){n=s.split("\n").slice(-2)[0]}if(n.includes(".m3u8")&&n!==r){r=urljoin(r,n);log("嵌套的m3u8_url:"+r);s=request(r,l).content}let a=s.trim().split("\n").filter(e=>e.trim()).join("\n");let p=a.split("\n");let c="";let u=0;let f=0;let d=1;let h=0;let m="";for(let t=0;t<p.length;t++){let e=p[t];if(!e.startsWith("#")){if(f==0)c=e;if(f>0){if(u>i(c,e)+1){if(m.length<5)m=e;h++}else{u=i(c,e);d++}}f++;if(f>=30)break}}if(h>d)c=m;let _=c.length;let g=Math.round(p.length/2).toString().length;let y=0;let v=p.toReversed().find(t=>{if(!t.startsWith("#")){let e=i(o(c),o(t));u=i(c,t);y++;if(_-u<=g+e||y>10){return true}}return false});log("最后一条切片："+v);let b=[];for(let t=0;t<p.length;t++){let e=p[t];if(!e.startsWith("#")){if(i(c,e)<u){b.push(e);p.splice(t-1,2);t=t-2}else{p[t]=urljoin(r,e)}}else{p[t]=e.replace(/URI=\"(.*)\"/,'URI="'+urljoin(r,"$1")+'"')}}log("处理的m3u8地址:"+r);log("----广告地址----");log(b);s=p.join("\n");log("处理耗时："+((new Date).getTime()-t).toString());log(s);return s}function forceOrder(r,e,t){let l=Math.floor(r.length/2);let i=Math.min(r.length-1,l+1);if(l>=i){return r}let o=r[l];let s=r[i];if(e){try{o=o[e];s=s[e]}catch(e){}}if(t&&typeof t==="function"){try{o=t(o);s=t(s)}catch(e){}}o+="";s+="";if(o.match(/(\d+)/)&&s.match(/(\d+)/)){let e=Number(o.match(/(\d+)/)[1]);let t=Number(s.match(/(\d+)/)[1]);if(e>t){r.reverse()}}return r}let VODS=[];let VOD={};let TABS=[];let LISTS=[];function getQuery(t){try{if(t.indexOf("?")>-1){t=t.slice(t.indexOf("?")+1)}let e=t.split("#")[0].split("&");const i={};e.forEach(e=>{let t=e.split("=");let r=t[0];let l=t.slice(1).join("=");i[r]=l});return i}catch(t){log(`getQuery发生错误:${e.message}`);return{}}}function urljoin(e,t){e=e||"";t=t||"";return joinUrl(e,t)}var urljoin2=urljoin;const defaultParser={pdfh:pdfh,pdfa:pdfa,pd:pd};function pdfh2(e,t){let r=e;try{if(typeof e!=="string"){r=e.rr(e.ele).toString()}}catch(e){print(`html对象转文本发生了错误:${e.message}`)}let l=defaultParser.pdfh(r,t);let i=t.includes("&&")?t.split("&&").slice(-1)[0]:t.split(" ").slice(-1)[0];if(/style/.test(i.toLowerCase())&&/url\(/.test(l)){try{l=l.match(/url\((.*?)\)/)[1];l=l.replace(/^['|"](.*)['|"]$/,"$1")}catch(e){}}return l}function pdfa2(e,t){let r=e;try{if(typeof e!=="string"){r=e.rr(e.ele).toString()}}catch(e){print(`html对象转文本发生了错误:${e.message}`)}return defaultParser.pdfa(r,t)}function pd2(e,t,r){let l=pdfh2(e,t);if(typeof r==="undefined"||!r){r=""}if(DOM_CHECK_ATTR.test(t)&&!SPECIAL_URL.test(l)){if(/http/.test(l)){l=l.slice(l.indexOf("http"))}else{l=urljoin(MY_URL,l)}}return l}const parseTags={jsp:{pdfh:pdfh2,pdfa:pdfa2,pd:pd2},json:{pdfh(r,e){if(!e||!e.trim()){return""}if(typeof r==="string"){r=JSON.parse(r)}e=e.trim();if(!e.startsWith("$.")){e="$."+e}e=e.split("||");for(let t of e){let e=cheerio.jp(t,r);if(Array.isArray(e)){e=e[0]||""}else{e=e||""}if(e&&typeof e!=="string"){e=e.toString()}if(e){return e}}return""},pdfa(e,t){if(!t||!t.trim()){return""}if(typeof e==="string"){e=JSON.parse(e)}t=t.trim();if(!t.startsWith("$.")){t="$."+t}let r=cheerio.jp(t,e);if(Array.isArray(r)&&Array.isArray(r[0])&&r.length===1){return r[0]||[]}return r||[]},pd(e,t){let r=parseTags.json.pdfh(e,t);if(r){return urljoin(MY_URL,r)}return r}},jq:{pdfh(e,t){if(!e||!t||!t.trim()){return""}t=t.trim();let r=defaultParser.pdfh(e,t);return r},pdfa(e,t){if(!e||!t||!t.trim()){return[]}t=t.trim();let r=defaultParser.pdfa(e,t);print(`pdfa解析${t}=>${r.length}`);return r},pd(e,t,r){if(!e||!t||!t.trim()){return""}t=t.trim();r=r||MY_URL;return defaultParser.pd(e,t,r)}},getParse(e){if(e.startsWith("jsp:")){return this.jsp}else if(e.startsWith("json:")){return this.json}else if(e.startsWith("jq:")){return this.jq}else{return this.jq}}};const stringify=JSON.stringify;const jsp=parseTags.jsp;const jq=parseTags.jq;function readFile(e){e=e||"./uri.min.js";var t=os.open(e);var r=new ArrayBuffer(1024);var l=os.read(t,r,0,1024);console.log(l);let i=String.fromCharCode.apply(null,new Uint8Array(r));console.log(i);return i}function dealJson(e){try{e=e.trim();if(!(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]"))){e="{"+e.match(/.*?\{(.*)\}/m)[1]+"}"}}catch(e){}try{e=JSON.parse(e)}catch(e){}return e}var OcrApi={api:OCR_API,classification:function(t){let r="";try{log("通过drpy_ocr验证码接口过验证...");let e="";if(this.api.endsWith("drpy/text")){e=request(this.api,{data:{img:t},headers:{"User-Agent":PC_UA},method:"POST"},true)}else{e=post(this.api,{body:t})}r=e||""}catch(e){log(`OCR识别验证码发生错误:${e.message}`)}return r}};function verifyCode(e){let n=0;let a=getHome(e);let p="";while(n<OCR_RETRY){try{let e=`${a}/index.php/verify/index.html`;console.log(`验证码链接:${e}`);let t=request(e,{withHeaders:true,toBase64:true},true);let r=JSON.parse(t);if(!p){let e=Object.keys(r).find(e=>e.toLowerCase()==="set-cookie");p=e?r[e].split(";")[0]:""}console.log("cookie:"+p);let l=r.body;let i=OcrApi.classification(l);console.log(`第${n+1}次验证码识别结果:${i}`);let o=`${a}/index.php/ajax/verify_check?type=search&verify=${i}`;console.log(o);let s=request(o,{headers:{Cookie:p},method:"POST"});s=JSON.parse(s);if(s.msg==="ok"){console.log(`第${n+1}次验证码提交成功`);return p}else if(s.msg!=="ok"&&n+1>=OCR_RETRY){p=""}}catch(e){console.log(`第${n+1}次验证码提交失败:${e.message}`);if(n+1>=OCR_RETRY){p=""}}n+=1}return p}function setItem(e,t){local.set(RKEY,e,t);console.log(`规则${RKEY}设置${e} => ${t}`)}function getItem(e,t){return local.get(RKEY,e)||t}function clearItem(e){local.delete(RKEY,e)}function getHome(e){if(!e){return""}let t=e.split("//");e=t[0]+"//"+t[1].split("/")[0];try{e=decodeURIComponent(e)}catch(e){}return e}function buildUrl(e,t){t=t||{};if(e.indexOf("?")<0){e+="?"}let r=[];let l=Object.keys(t);l.forEach(e=>{r.push(e+"="+t[e])});let i=r.join("&");if(l.length>0&&!e.endsWith("?")){e+="&"}e+=i;return e}function $require(url){eval(request(url))}function keysToLowerCase(l){return Object.keys(l).reduce((e,t)=>{const r=t.toLowerCase();e[r]=l[t];return e},{})}function parseQueryString(e){const o={};e.split("&").forEach(function(e){const t=/^(.*?)=(.*)/;const r=e.match(t);if(r){const l=decodeURIComponent(r[1]);const i=decodeURIComponent(r[2]);o[l]=i}});return o}function encodeIfContainsSpecialChars(t){const e=":/?#[]@!$'()*+,;=%";if(e.split("").some(e=>t.includes(e))){return encodeURIComponent(t)}return t}function objectToQueryString(t){const r=[];for(let e in t){if(t.hasOwnProperty(e)){r.push(encodeURIComponent(e)+"="+encodeIfContainsSpecialChars(t[e]))}}return r.join("&")}function request(r,l,e){e=e||false;if(typeof l==="undefined"||!l||l==={}){if(!fetch_params||!fetch_params.headers){let e={"User-Agent":MOBILE_UA};if(rule.headers){Object.assign(e,rule.headers)}if(!fetch_params){fetch_params={}}fetch_params.headers=e}if(!fetch_params.headers.Referer){fetch_params.headers.Referer=getHome(r)}l=fetch_params}else{let t=l.headers||{};let e=Object.keys(t).map(e=>e.toLowerCase());if(!e.includes("user-agent")){t["User-Agent"]=MOBILE_UA;if(typeof fetch_params==="object"&&fetch_params&&fetch_params.headers){let e=keysToLowerCase(fetch_params.headers);if(e["user-agent"]){t["User-Agent"]=e["user-agent"]}}}if(!e.includes("referer")){t["Referer"]=getHome(r)}l.headers=t}if(rule.encoding&&rule.encoding!=="utf-8"&&!e){if(!l.headers.hasOwnProperty("Content-Type")&&!l.headers.hasOwnProperty("content-type")){l.headers["Content-Type"]="text/html; charset="+rule.encoding}}if(typeof l.body!="undefined"&&l.body&&typeof l.body==="string"){if(!l.headers.hasOwnProperty("Content-Type")&&!l.headers.hasOwnProperty("content-type")){l.headers["Content-Type"]="application/x-www-form-urlencoded; charset="+rule.encoding}}else if(typeof l.body!="undefined"&&l.body&&typeof l.body==="object"){l.data=l.body;delete l.body}if(!r){return l.withHeaders?"{}":""}if(l.toBase64){l.buffer=2;delete l.toBase64}if(l.redirect===false){l.redirect=0}if(l.headers.hasOwnProperty("Content-Type")||l.headers.hasOwnProperty("content-type")){let e=l.headers["Content-Type"]||l.headers["content-type"]||"";if(e.includes("application/x-www-form-urlencoded")){log("custom body is application/x-www-form-urlencoded");if(typeof l.body=="string"){let e=parseQueryString(l.body);console.log(JSON.stringify(e))}}}console.log(JSON.stringify(l.headers));console.log("request:"+r+`|method:${l.method||"GET"}|body:${l.body||""}`);let t=req(r,l);let i=t.content||"";if(l.withHeaders){let e=t.headers;e.body=i;return JSON.stringify(e)}else{return i}}function post(e,t){t=t||{};t.method="POST";return request(e,t)}function reqCookie(e,t,r){t=t||{};t.withHeaders=true;r=r||false;let l=request(e,t);let i=JSON.parse(l);let o=Object.keys(i).find(e=>e.toLowerCase()==="set-cookie");let s=o?i[o]:"";if(Array.isArray(s)){s=s.join(";")}if(!r){s=s.split(";")[0]}l=i.body;return{cookie:s,html:l}}fetch=request;print=function(t){t=t||"";if(typeof t=="object"&&Object.keys(t).length>0){try{t=JSON.stringify(t);console.log(t)}catch(e){console.log(typeof t+":"+t.length);return}}else if(typeof t=="object"&&Object.keys(t).length<1){console.log("null object")}else{console.log(t)}};log=print;function checkHtml(t,r,l){if(/\?btwaf=/.test(t)){let e=t.match(/btwaf(.*?)"/)[1];r=r.split("#")[0]+"?btwaf"+e;print("宝塔验证访问链接:"+r);t=request(r,l)}return t}function getCode(e,t){let r=request(e,t);r=checkHtml(r,e,t);return r}function getHtml(e){let t={};if(rule.headers){t.headers=rule.headers}let r=getItem(RULE_CK,"");if(r){if(t.headers&&!Object.keys(t.headers).map(e=>e.toLowerCase()).includes("cookie")){log("历史无cookie,新增过验证后的cookie");t.headers["Cookie"]=r}else if(t.headers&&t.headers.cookie&&t.headers.cookie!==r){t.headers["Cookie"]=r;log("历史有小写过期的cookie,更新过验证后的cookie")}else if(t.headers&&t.headers.Cookie&&t.headers.Cookie!==r){t.headers["Cookie"]=r;log("历史有大写过期的cookie,更新过验证后的cookie")}else if(!t.headers){t.headers={Cookie:r};log("历史无headers,更新过验证后的含cookie的headers")}}let l=getCode(e,t);return l}function homeParse(homeObj){fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let classes=[];if(homeObj.class_name&&homeObj.class_url){let names=homeObj.class_name.split("&");let urls=homeObj.class_url.split("&");let cnt=Math.min(names.length,urls.length);for(let i=0;i<cnt;i++){classes.push({type_id:urls[i],type_name:names[i]})}}if(homeObj.class_parse){if(homeObj.class_parse.startsWith("js:")){var input=homeObj.MY_URL;try{eval(homeObj.class_parse.replace("js:",""));if(Array.isArray(input)){classes=input}}catch(e){log(`通过js动态获取分类发生了错误:${e.message}`)}}else{let p=homeObj.class_parse.split(";");let p0=p[0];let _ps=parseTags.getParse(p0);let is_json=p0.startsWith("json:");_pdfa=_ps.pdfa;_pdfh=_ps.pdfh;_pd=_ps.pd;MY_URL=rule.url;if(is_json){try{let cms_cate_url=homeObj.MY_URL.replace("ac=detail","ac=list");let html=homeObj.home_html||getHtml(cms_cate_url);if(html){if(cms_cate_url===homeObj.MY_URL){homeHtmlCache=html}let list=_pdfa(html,p0.replace("json:",""));if(list&&list.length>0){classes=list}}}catch(e){console.log(e.message)}}else if(p.length>=3&&!is_json){try{let html=homeObj.home_html||getHtml(homeObj.MY_URL);if(html){homeHtmlCache=html;let list=_pdfa(html,p0);if(list&&list.length>0){list.forEach((r,t)=>{try{let e=_pdfh(r,p[1]);if(homeObj.cate_exclude&&new RegExp(homeObj.cate_exclude).test(e)){return}let t=_pd(r,p[2]);if(p.length>3&&p[3]&&!homeObj.home_html){let e=new RegExp(p[3]);t=t.match(e)[1]}classes.push({type_id:t.trim(),type_name:e.trim()})}catch(e){console.log(`分类列表定位第${t}个元素正常报错:${e.message}`)}})}}}catch(e){console.log(e.message)}}}}classes=classes.filter(e=>!homeObj.cate_exclude||!new RegExp(homeObj.cate_exclude).test(e.type_name));let resp={class:classes};if(homeObj.filter){resp.filters=homeObj.filter}console.log(JSON.stringify(resp));return JSON.stringify(resp)}function getPP(t,r,l,i){try{let e=t[r]==="*"&&l.length>i?l[i]:t[r];return e}catch(e){return""}}function homeVodParse(homeVodObj){fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let d=[];MY_URL=homeVodObj.homeUrl;console.log(MY_URL);let t1=(new Date).getTime();let p=homeVodObj.推荐;print("p:"+p);if(p==="*"&&rule.一级){p=rule.一级;homeVodObj.double=false}if(!p||typeof p!=="string"){return"{}"}p=p.trim();let pp=rule.一级?rule.一级.split(";"):[];if(p.startsWith("js:")){const TYPE="home";var input=MY_URL;HOST=rule.host;eval(p.replace("js:",""));d=VODS}else{p=p.split(";");if(!homeVodObj.double&&p.length<5){return"{}"}else if(homeVodObj.double&&p.length<6){return"{}"}let p0=getPP(p,0,pp,0);let _ps=parseTags.getParse(p0);_pdfa=_ps.pdfa;_pdfh=_ps.pdfh;_pd=_ps.pd;let is_json=p0.startsWith("json:");p0=p0.replace(/^(jsp:|json:|jq:)/,"");let html=homeHtmlCache||getHtml(MY_URL);homeHtmlCache=undefined;if(is_json){html=dealJson(html)}try{console.log("double:"+homeVodObj.double);if(homeVodObj.double){let items=_pdfa(html,p0);let p1=getPP(p,1,pp,0);let p2=getPP(p,2,pp,1);let p3=getPP(p,3,pp,2);let p4=getPP(p,4,pp,3);let p5=getPP(p,5,pp,4);let p6=getPP(p,6,pp,5);for(let item of items){let items2=_pdfa(item,p1);for(let item2 of items2){try{let title=_pdfh(item2,p2);let img="";try{img=_pd(item2,p3)}catch(e){}let desc="";try{desc=_pdfh(item2,p4)}catch(e){}let links=[];for(let _p5 of p5.split("+")){let link=!homeVodObj.detailUrl?_pd(item2,_p5,MY_URL):_pdfh(item2,_p5);links.push(link)}let content;if(p.length>6&&p[6]){content=_pdfh(item2,p6)}else{content=""}let vid=links.join("$");if(rule.二级==="*"){vid=vid+"@@"+title+"@@"+img}let vod={vod_name:title,vod_pic:img,vod_remarks:desc,vod_content:content,vod_id:vid};d.push(vod)}catch(e){console.log(`首页列表双层定位处理发生错误:${e.message}`)}}}}else{let items=_pdfa(html,p0);let p1=getPP(p,1,pp,1);let p2=getPP(p,2,pp,2);let p3=getPP(p,3,pp,3);let p4=getPP(p,4,pp,4);let p5=getPP(p,5,pp,5);for(let item of items){try{let title=_pdfh(item,p1);let img="";try{img=_pd(item,p2,MY_URL)}catch(e){}let desc="";try{desc=_pdfh(item,p3)}catch(e){}let links=[];for(let _p5 of p4.split("+")){let link=!homeVodObj.detailUrl?_pd(item,_p5,MY_URL):_pdfh(item,_p5);links.push(link)}let content;if(p.length>5&&p[5]){content=_pdfh(item,p5)}else{content=""}let vid=links.join("$");if(rule.二级==="*"){vid=vid+"@@"+title+"@@"+img}let vod={vod_name:title,vod_pic:img,vod_remarks:desc,vod_content:content,vod_id:vid};d.push(vod)}catch(e){console.log(`首页列表单层定位处理发生错误:${e.message}`)}}}}catch(e){}}let t2=(new Date).getTime();console.log("加载首页推荐耗时:"+(t2-t1)+"毫秒");if(rule.图片替换){if(rule.图片替换.startsWith("js:")){d.forEach(it=>{try{var input=it.vod_pic;eval(rule.图片替换.trim().replace("js:",""));it.vod_pic=input}catch(e){log(`图片:${it.vod_pic}替换错误:${e.message}`)}})}else if(rule.图片替换.includes("=>")){let replace_from=rule.图片替换.split("=>")[0];let replace_to=rule.图片替换.split("=>")[1];d.forEach(e=>{if(e.vod_pic&&e.vod_pic.startsWith("http")){e.vod_pic=e.vod_pic.replace(replace_from,replace_to)}})}}if(rule.图片来源){d.forEach(e=>{if(e.vod_pic&&e.vod_pic.startsWith("http")){e.vod_pic=e.vod_pic+rule.图片来源}})}if(d.length>0){print(d.slice(0,2))}return JSON.stringify({list:d})}function categoryParse(cateObj){fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let p=cateObj.一级;if(!p||typeof p!=="string"){return"{}"}let d=[];let url=cateObj.url.replaceAll("fyclass",cateObj.tid);if(cateObj.pg===1&&url.includes("[")&&url.includes("]")){url=url.split("[")[1].split("]")[0]}else if(cateObj.pg>1&&url.includes("[")&&url.includes("]")){url=url.split("[")[0]}if(rule.filter_url){if(!/fyfilter/.test(url)){if(!url.endsWith("&")&&!rule.filter_url.startsWith("&")){url+="&"}url+=rule.filter_url}else{url=url.replace("fyfilter",rule.filter_url)}url=url.replaceAll("fyclass",cateObj.tid);let fl=cateObj.filter?cateObj.extend:{};if(rule.filter_def&&typeof rule.filter_def==="object"){try{if(Object.keys(rule.filter_def).length>0&&rule.filter_def.hasOwnProperty(cateObj.tid)){let self_fl_def=rule.filter_def[cateObj.tid];if(self_fl_def&&typeof self_fl_def==="object"){let fl_def=JSON.parse(JSON.stringify(self_fl_def));fl=Object.assign(fl_def,fl)}}}catch(e){print(`合并不同分类对应的默认筛选出错:${e.message}`)}}let new_url;new_url=cheerio.jinja2(url,{fl:fl,fyclass:cateObj.tid});url=new_url}if(/fypage/.test(url)){if(url.includes("(")&&url.includes(")")){let url_rep=url.match(/.*?\((.*)\)/)[1];let cnt_page=url_rep.replaceAll("fypage",cateObj.pg);let cnt_pg=eval(cnt_page);url=url.replaceAll(url_rep,cnt_pg).replaceAll("(","").replaceAll(")","")}else{url=url.replaceAll("fypage",cateObj.pg)}}MY_URL=url;console.log(MY_URL);p=p.trim();const MY_CATE=cateObj.tid;if(p.startsWith("js:")){var MY_FL=cateObj.extend;const TYPE="cate";var input=MY_URL;const MY_PAGE=cateObj.pg;var desc="";eval(p.trim().replace("js:",""));d=VODS}else{p=p.split(";");if(p.length<5){return"{}"}let _ps=parseTags.getParse(p[0]);_pdfa=_ps.pdfa;_pdfh=_ps.pdfh;_pd=_ps.pd;let is_json=p[0].startsWith("json:");p[0]=p[0].replace(/^(jsp:|json:|jq:)/,"");try{let html=getHtml(MY_URL);if(html){if(is_json){html=dealJson(html)}let list=_pdfa(html,p[0]);list.forEach(t=>{let e=p[4].split("+").map(e=>{return!rule.detailUrl?_pd(t,e,MY_URL):_pdfh(t,e)});let r=e.join("$");let l=rule.detailUrl?MY_CATE+"$"+r:r;let i=_pdfh(t,p[1]).replace(/\n|\t/g,"").trim();let o=_pd(t,p[2],MY_URL);if(rule.二级==="*"){l=l+"@@"+i+"@@"+o}d.push({vod_id:l,vod_name:i,vod_pic:o,vod_remarks:_pdfh(t,p[3]).replace(/\n|\t/g,"").trim()})})}}catch(e){console.log(e.message)}}if(rule.图片替换){if(rule.图片替换.startsWith("js:")){d.forEach(it=>{try{var input=it.vod_pic;eval(rule.图片替换.trim().replace("js:",""));it.vod_pic=input}catch(e){log(`图片:${it.vod_pic}替换错误:${e.message}`)}})}else if(rule.图片替换.includes("=>")){let replace_from=rule.图片替换.split("=>")[0];let replace_to=rule.图片替换.split("=>")[1];d.forEach(e=>{if(e.vod_pic&&e.vod_pic.startsWith("http")){e.vod_pic=e.vod_pic.replace(replace_from,replace_to)}})}}if(rule.图片来源){d.forEach(e=>{if(e.vod_pic&&e.vod_pic.startsWith("http")){e.vod_pic=e.vod_pic+rule.图片来源}})}if(d.length>0){print(d.slice(0,2))}let pagecount=0;if(rule.pagecount&&typeof rule.pagecount==="object"&&rule.pagecount.hasOwnProperty(MY_CATE)){print(`MY_CATE:${MY_CATE},pagecount:${JSON.stringify(rule.pagecount)}`);pagecount=parseInt(rule.pagecount[MY_CATE])}let nodata={list:[{vod_name:"无数据,防无限请求",vod_id:"no_data",vod_remarks:"不要点,会崩的",vod_pic:"https://ghproxy.net/https://raw.githubusercontent.com/hjdhnx/dr_py/main/404.jpg"}],total:1,pagecount:1,page:1,limit:1};let vod=d.length<1?JSON.stringify(nodata):JSON.stringify({page:parseInt(cateObj.pg),pagecount:pagecount||999,limit:20,total:999,list:d});return vod}function searchParse(searchObj){fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let d=[];if(!searchObj.searchUrl){return"{}"}if(rule.searchNoPage&&Number(searchObj.pg)>1){return"{}"}let p=searchObj.搜索==="*"&&rule.一级?rule.一级:searchObj.搜索;if(!p||typeof p!=="string"){return"{}"}p=p.trim();let pp=rule.一级?rule.一级.split(";"):[];let url=searchObj.searchUrl.replaceAll("**",searchObj.wd);if(searchObj.pg===1&&url.includes("[")&&url.includes("]")&&!url.includes("#")){url=url.split("[")[1].split("]")[0]}else if(searchObj.pg>1&&url.includes("[")&&url.includes("]")&&!url.includes("#")){url=url.split("[")[0]}if(/fypage/.test(url)){if(url.includes("(")&&url.includes(")")){let url_rep=url.match(/.*?\((.*)\)/)[1];let cnt_page=url_rep.replaceAll("fypage",searchObj.pg);let cnt_pg=eval(cnt_page);url=url.replaceAll(url_rep,cnt_pg).replaceAll("(","").replaceAll(")","")}else{url=url.replaceAll("fypage",searchObj.pg)}}MY_URL=url;console.log(MY_URL);if(p.startsWith("js:")){const TYPE="search";const MY_PAGE=searchObj.pg;const KEY=searchObj.wd;var input=MY_URL;var detailUrl=rule.detailUrl||"";eval(p.trim().replace("js:",""));d=VODS}else{p=p.split(";");if(p.length<5){return"{}"}let p0=getPP(p,0,pp,0);let _ps=parseTags.getParse(p0);_pdfa=_ps.pdfa;_pdfh=_ps.pdfh;_pd=_ps.pd;let is_json=p0.startsWith("json:");p0=p0.replace(/^(jsp:|json:|jq:)/,"");try{let req_method=MY_URL.split(";").length>1?MY_URL.split(";")[1].toLowerCase():"get";let html;if(req_method==="post"){let rurls=MY_URL.split(";")[0].split("#");let rurl=rurls[0];let params=rurls.length>1?rurls[1]:"";print(`post=》rurl:${rurl},params:${params}`);let _fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let postData={body:params};Object.assign(_fetch_params,postData);html=post(rurl,_fetch_params)}else if(req_method==="postjson"){let rurls=MY_URL.split(";")[0].split("#");let rurl=rurls[0];let params=rurls.length>1?rurls[1]:"";print(`postjson-》rurl:${rurl},params:${params}`);try{params=JSON.parse(params)}catch(e){params="{}"}let _fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let postData={body:params};Object.assign(_fetch_params,postData);html=post(rurl,_fetch_params)}else{html=getHtml(MY_URL)}if(html){let search_tag=rule.搜索验证标识||"系统安全验证|输入验证码";if(new RegExp(search_tag).test(html)){let cookie=verifyCode(MY_URL);if(cookie){console.log(`本次成功过验证,cookie:${cookie}`);setItem(RULE_CK,cookie)}else{console.log(`本次自动过搜索验证失败,cookie:${cookie}`)}html=getHtml(MY_URL)}if(!html.includes(searchObj.wd)){console.log("搜索结果源码未包含关键字,疑似搜索失败,正为您打印结果源码");console.log(html)}if(is_json){html=dealJson(html)}let list=_pdfa(html,p0);let p1=getPP(p,1,pp,1);let p2=getPP(p,2,pp,2);let p3=getPP(p,3,pp,3);let p4=getPP(p,4,pp,4);let p5=getPP(p,5,pp,5);list.forEach(t=>{let e=p4.split("+").map(e=>{return!rule.detailUrl?_pd(t,e,MY_URL):_pdfh(t,e)});let r=e.join("$");let l;if(p.length>5&&p[5]){l=_pdfh(t,p5)}else{l=""}let i=r;let o=_pdfh(t,p1).replace(/\n|\t/g,"").trim();let s=_pd(t,p2,MY_URL);if(rule.二级==="*"){i=i+"@@"+o+"@@"+s}let n={vod_id:i,vod_name:o,vod_pic:s,vod_remarks:_pdfh(t,p3).replace(/\n|\t/g,"").trim(),vod_content:l.replace(/\n|\t/g,"").trim()};d.push(n)})}}catch(e){print(`搜索发生错误:${e.message}`);return"{}"}}if(rule.图片替换){if(rule.图片替换.startsWith("js:")){d.forEach(it=>{try{var input=it.vod_pic;eval(rule.图片替换.trim().replace("js:",""));it.vod_pic=input}catch(e){log(`图片:${it.vod_pic}替换错误:${e.message}`)}})}else if(rule.图片替换.includes("=>")){let replace_from=rule.图片替换.split("=>")[0];let replace_to=rule.图片替换.split("=>")[1];d.forEach(e=>{if(e.vod_pic&&e.vod_pic.startsWith("http")){e.vod_pic=e.vod_pic.replace(replace_from,replace_to)}})}}if(rule.图片来源){d.forEach(e=>{if(e.vod_pic&&e.vod_pic.startsWith("http")){e.vod_pic=e.vod_pic+rule.图片来源}})}return JSON.stringify({page:parseInt(searchObj.pg),pagecount:10,limit:20,total:100,list:d})}function detailParse(detailObj){let t1=(new Date).getTime();fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));let orId=detailObj.orId;let vod_name="片名";let vod_pic="";let vod_id=orId;if(rule.二级==="*"){let extra=orId.split("@@");vod_name=extra.length>1?extra[1]:vod_name;vod_pic=extra.length>2?extra[2]:vod_pic}let vod={vod_id:vod_id,vod_name:vod_name,vod_pic:vod_pic,type_name:"类型",vod_year:"年份",vod_area:"地区",vod_remarks:"更新信息",vod_actor:"主演",vod_director:"导演",vod_content:"简介"};let p=detailObj.二级;let url=detailObj.url;let detailUrl=detailObj.detailUrl;let fyclass=detailObj.fyclass;let tab_exclude=detailObj.tab_exclude;let html=detailObj.html||"";MY_URL=url;if(detailObj.二级访问前){try{print(`尝试在二级访问前执行代码:${detailObj.二级访问前}`);eval(detailObj.二级访问前.trim().replace("js:",""))}catch(e){print(`二级访问前执行代码出现错误:${e.message}`)}}if(p==="*"){vod.vod_play_from="道长在线";vod.vod_remarks=detailUrl;vod.vod_actor="没有二级,只有一级链接直接嗅探播放";vod.vod_content=MY_URL;vod.vod_play_url="嗅探播放$"+MY_URL.split("@@")[0]}else if(typeof p==="string"&&p.trim().startsWith("js:")){const TYPE="detail";var input=MY_URL;var play_url="";eval(p.trim().replace("js:",""));vod=VOD;console.log(JSON.stringify(vod))}else if(p&&typeof p==="object"){let tt1=(new Date).getTime();if(!html){html=getHtml(MY_URL)}print(`二级${MY_URL}仅获取源码耗时:${(new Date).getTime()-tt1}毫秒`);let _ps;if(p.is_json){print("二级是json");_ps=parseTags.json;html=dealJson(html)}else if(p.is_jsp){print("二级是jsp");_ps=parseTags.jsp}else if(p.is_jq){print("二级是jq");_ps=parseTags.jq}else{print("二级默认jq");_ps=parseTags.jq}let tt2=(new Date).getTime();print(`二级${MY_URL}获取并装载源码耗时:${tt2-tt1}毫秒`);_pdfa=_ps.pdfa;_pdfh=_ps.pdfh;_pd=_ps.pd;if(p.title){let p1=p.title.split(";");vod.vod_name=_pdfh(html,p1[0]).replace(/\n|\t/g,"").trim();let type_name=p1.length>1?_pdfh(html,p1[1]).replace(/\n|\t/g,"").replace(/ /g,"").trim():"";vod.type_name=type_name||vod.type_name}if(p.desc){try{let p1=p.desc.split(";");vod.vod_remarks=_pdfh(html,p1[0]).replace(/\n|\t/g,"").trim();vod.vod_year=p1.length>1?_pdfh(html,p1[1]).replace(/\n|\t/g,"").trim():"";vod.vod_area=p1.length>2?_pdfh(html,p1[2]).replace(/\n|\t/g,"").trim():"";vod.vod_actor=p1.length>3?_pdfh(html,p1[3]).replace(/\n|\t/g,"").trim():"";vod.vod_director=p1.length>4?_pdfh(html,p1[4]).replace(/\n|\t/g,"").trim():""}catch(e){}}if(p.content){try{let p1=p.content.split(";");vod.vod_content=_pdfh(html,p1[0]).replace(/\n|\t/g,"").trim()}catch(e){}}if(p.img){try{let p1=p.img.split(";");vod.vod_pic=_pd(html,p1[0],MY_URL)}catch(e){}}let vod_play_from="$$$";let playFrom=[];if(p.重定向&&p.重定向.startsWith("js:")){print("开始执行重定向代码:"+p.重定向);html=eval(p.重定向.replace("js:",""))}if(p.tabs){if(p.tabs.startsWith("js:")){print("开始执行tabs代码:"+p.tabs);var input=MY_URL;eval(p.tabs.replace("js:",""));playFrom=TABS}else{let p_tab=p.tabs.split(";")[0];let vHeader=_pdfa(html,p_tab);console.log(vHeader.length);let tab_text=p.tab_text||"body&&Text";let new_map={};for(let v of vHeader){let v_title=_pdfh(v,tab_text).trim();if(!v_title){v_title="线路空"}console.log(v_title);if(tab_exclude&&new RegExp(tab_exclude).test(v_title)){continue}if(!new_map.hasOwnProperty(v_title)){new_map[v_title]=1}else{new_map[v_title]+=1}if(new_map[v_title]>1){v_title+=Number(new_map[v_title]-1)}playFrom.push(v_title)}}console.log(JSON.stringify(playFrom))}else{playFrom=["道长在线"]}vod.vod_play_from=playFrom.join(vod_play_from);let vod_play_url="$$$";let vod_tab_list=[];if(p.lists){if(p.lists.startsWith("js:")){print("开始执行lists代码:"+p.lists);try{var input=MY_URL;var play_url="";eval(p.lists.replace("js:",""));for(let i in LISTS){if(LISTS.hasOwnProperty(i)){try{LISTS[i]=LISTS[i].map(e=>e.split("$").slice(0,2).join("$"))}catch(e){print(`格式化LISTS发生错误:${e.message}`)}}}vod_play_url=LISTS.map(e=>e.join("#")).join(vod_play_url)}catch(e){print(`js执行lists: 发生错误:${e.message}`)}}else{let list_text=p.list_text||"body&&Text";let list_url=p.list_url||"a&&href";let list_url_prefix=p.list_url_prefix||"";let is_tab_js=p.tabs.trim().startsWith("js:");for(let i=0;i<playFrom.length;i++){let tab_name=playFrom[i];let tab_ext=p.tabs.split(";").length>1&&!is_tab_js?p.tabs.split(";")[1]:"";let p1=p.lists.replaceAll("#idv",tab_name).replaceAll("#id",i);tab_ext=tab_ext.replaceAll("#idv",tab_name).replaceAll("#id",i);let tabName=tab_ext?_pdfh(html,tab_ext):tab_name;console.log(tabName);let new_vod_list=[];let tt1=(new Date).getTime();if(typeof pdfl==="function"){new_vod_list=pdfl(html,p1,list_text,list_url,MY_URL);if(list_url_prefix){new_vod_list=new_vod_list.map(e=>e.split("$")[0]+"$"+list_url_prefix+e.split("$").slice(1).join("$"))}}else{let vodList=[];try{vodList=_pdfa(html,p1);console.log("len(vodList):"+vodList.length)}catch(e){}for(let i=0;i<vodList.length;i++){let it=vodList[i];new_vod_list.push(_pdfh(it,list_text).trim()+"$"+list_url_prefix+_pd(it,list_url,MY_URL))}}if(new_vod_list.length>0){new_vod_list=forceOrder(new_vod_list,"",e=>e.split("$")[0]);console.log(`drpy影响性能代码共计列表数循环次数:${new_vod_list.length},耗时:${(new Date).getTime()-tt1}毫秒`)}let vlist=new_vod_list.join("#");vod_tab_list.push(vlist)}vod_play_url=vod_tab_list.join(vod_play_url)}}vod.vod_play_url=vod_play_url}if(rule.图片替换&&rule.图片替换.includes("=>")){let replace_from=rule.图片替换.split("=>")[0];let replace_to=rule.图片替换.split("=>")[1];vod.vod_pic=vod.vod_pic.replace(replace_from,replace_to)}if(rule.图片来源&&vod.vod_pic&&vod.vod_pic.startsWith("http")){vod.vod_pic=vod.vod_pic+rule.图片来源}if(!vod.vod_id||vod_id.includes("$")&&vod.vod_id!==vod_id){vod.vod_id=vod_id}let t2=(new Date).getTime();console.log(`加载二级界面${MY_URL}耗时:${t2-t1}毫秒`);try{vod=vodDeal(vod)}catch(e){console.log(`vodDeal发生错误:${e.message}`)}return JSON.stringify({list:[vod]})}function get_tab_index(e){let r={};e.vod_play_from.split("$$$").forEach((e,t)=>{r[e]=t});return r}function vodDeal(e){let r=e.vod_play_from.split("$$$");let l=e.vod_play_url.split("$$$");let i=r;let o=r;let t=r;let s=r;let n=l;if(rule.tab_remove&&rule.tab_remove.length>0||rule.tab_order&&rule.tab_order.length>0){let t=get_tab_index(e);if(rule.tab_remove&&rule.tab_remove.length>0){i=r.filter(e=>!rule.tab_remove.includes(e));s=i}if(rule.tab_order&&rule.tab_order.length>0){let r=rule.tab_order;o=i.sort((e,t)=>{return(r.indexOf(e)===-1?9999:r.indexOf(e))-(r.indexOf(t)===-1?9999:r.indexOf(t))});s=o}n=s.map(e=>l[t[e]])}if(rule.tab_rename&&typeof rule.tab_rename==="object"&Object.keys(rule.tab_rename).length>0){t=s.map(e=>rule.tab_rename[e]||e);s=t}e.vod_play_from=s.join("$$$");e.vod_play_url=n.join("$$$");return e}function tellIsJx(t){try{let e=!/\.(m3u8|mp4|m4a)$/.test(t.split("?")[0])&&是否正版(t);return e?1:0}catch(e){return 1}}function playParse(playObj){fetch_params=JSON.parse(JSON.stringify(rule_fetch_params));MY_URL=playObj.url;var MY_FLAG=playObj.flag;if(!/http/.test(MY_URL)){try{MY_URL=base64Decode(MY_URL)}catch(e){}}MY_URL=decodeURIComponent(MY_URL);var input=MY_URL;var flag=MY_FLAG;let common_play={parse:SPECIAL_URL.test(input)||/^(push:)/.test(input)?0:1,url:input,flag:flag,jx:tellIsJx(input)};let lazy_play;if(!rule.play_parse||!rule.lazy){lazy_play=common_play}else if(rule.play_parse&&rule.lazy&&typeof rule.lazy==="string"){try{let lazy_code=rule.lazy.trim();if(lazy_code.startsWith("js:")){lazy_code=lazy_code.replace("js:","").trim()}print("开始执行js免嗅=>"+lazy_code);eval(lazy_code);lazy_play=typeof input==="object"?input:{parse:SPECIAL_URL.test(input)||/^(push:)/.test(input)?0:1,jx:tellIsJx(input),url:input}}catch(e){print(`js免嗅错误:${e.message}`);lazy_play=common_play}}else{lazy_play=common_play}if(Array.isArray(rule.play_json)&&rule.play_json.length>0){let web_url=lazy_play.url;for(let pjson of rule.play_json){if(pjson.re&&(pjson.re==="*"||web_url.match(new RegExp(pjson.re)))){if(pjson.json&&typeof pjson.json==="object"){let base_json=pjson.json;lazy_play=Object.assign(lazy_play,base_json);break}}}}else if(rule.play_json&&!Array.isArray(rule.play_json)){let base_json={jx:1,parse:1};lazy_play=Object.assign(lazy_play,base_json)}else if(!rule.play_json){let base_json={jx:0,parse:1};lazy_play=Object.assign(lazy_play,base_json)}console.log(JSON.stringify(lazy_play));return JSON.stringify(lazy_play)}function proxyParse(proxyObj){var input=proxyObj.params;if(proxyObj.proxy_rule){log("准备执行本地代理规则:\n"+proxyObj.proxy_rule);try{eval(proxyObj.proxy_rule);if(input&&input!==proxyObj.params&&Array.isArray(input)&&input.length>=3){return input}else{return[404,"text/plain","Not Found"]}}catch(e){return[500,"text/plain","代理规则错误:"+e.message]}}else{return[404,"text/plain","Not Found"]}}function isVideoParse(isVideoObj){var input=isVideoObj.url;if(!isVideoObj.t){let re_matcher=new RegExp(isVideoObj.isVideo,"i");return re_matcher.test(input)}else{try{eval(isVideoObj.isVideo);if(typeof input==="boolean"){return input}else{return false}}catch(e){log(`执行嗅探规则发生错误:${e.message}`);return false}}}function getOriginalJs(e){let t=/var rule|[\u4E00-\u9FA5]+|function|let |var |const |\(|\)|"|'/;if(t.test(e)){return e}let r="MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCqin/jUpqM6+fgYP/oMqj9zcdHMM0mEZXLeTyixIJWP53lzJV2N2E3OP6BBpUmq2O1a9aLnTIbADBaTulTNiOnVGoNG58umBnupnbmmF8iARbDp2mTzdMMeEgLdrfXS6Y3VvazKYALP8EhEQykQVarexR78vRq7ltY3quXx7cgI0ROfZz5Sw3UOLQJ+VoWmwIxu9AMEZLVzFDQN93hzuzs3tNyHK6xspBGB7zGbwCg+TKi0JeqPDrXxYUpAz1cQ/MO+Da0WgvkXnvrry8NQROHejdLVOAslgr6vYthH9bKbsGyNY3H+P12kcxo9RAcVveONnZbcMyxjtF5dWblaernAgMBAAECggEAGdEHlSEPFmAr5PKqKrtoi6tYDHXdyHKHC5tZy4YV+Pp+a6gxxAiUJejx1hRqBcWSPYeKne35BM9dgn5JofgjI5SKzVsuGL6bxl3ayAOu+xXRHWM9f0t8NHoM5fdd0zC3g88dX3fb01geY2QSVtcxSJpEOpNH3twgZe6naT2pgiq1S4okpkpldJPo5GYWGKMCHSLnKGyhwS76gF8bTPLoay9Jxk70uv6BDUMlA4ICENjmsYtd3oirWwLwYMEJbSFMlyJvB7hjOjR/4RpT4FPnlSsIpuRtkCYXD4jdhxGlvpXREw97UF2wwnEUnfgiZJ2FT/MWmvGGoaV/CfboLsLZuQKBgQDTNZdJrs8dbijynHZuuRwvXvwC03GDpEJO6c1tbZ1s9wjRyOZjBbQFRjDgFeWs9/T1aNBLUrgsQL9c9nzgUziXjr1Nmu52I0Mwxi13Km/q3mT+aQfdgNdu6ojsI5apQQHnN/9yMhF6sNHg63YOpH+b+1bGRCtr1XubuLlumKKscwKBgQDOtQ2lQjMtwsqJmyiyRLiUOChtvQ5XI7B2mhKCGi8kZ+WEAbNQcmThPesVzW+puER6D4Ar4hgsh9gCeuTaOzbRfZ+RLn3Aksu2WJEzfs6UrGvm6DU1INn0z/tPYRAwPX7sxoZZGxqML/z+/yQdf2DREoPdClcDa2Lmf1KpHdB+vQKBgBXFCVHz7a8n4pqXG/HvrIMJdEpKRwH9lUQS/zSPPtGzaLpOzchZFyQQBwuh1imM6Te+VPHeldMh3VeUpGxux39/m+160adlnRBS7O7CdgSsZZZ/dusS06HAFNraFDZf1/VgJTk9BeYygX+AZYu+0tReBKSs9BjKSVJUqPBIVUQXAoGBAJcZ7J6oVMcXxHxwqoAeEhtvLcaCU9BJK36XQ/5M67ceJ72mjJC6/plUbNukMAMNyyi62gO6I9exearecRpB/OGIhjNXm99Ar59dAM9228X8gGfryLFMkWcO/fNZzb6lxXmJ6b2LPY3KqpMwqRLTAU/zy+ax30eFoWdDHYa4X6e1AoGAfa8asVGOJ8GL9dlWufEeFkDEDKO9ww5GdnpN+wqLwePWqeJhWCHad7bge6SnlylJp5aZXl1+YaBTtOskC4Whq9TP2J+dNIgxsaF5EFZQJr8Xv+lY9lu0CruYOh9nTNF9x3nubxJgaSid/7yRPfAGnsJRiknB5bsrCvgsFQFjJVs=";let l="";function i(e){let t=CryptoJS.enc.Hex.parse("686A64686E780A0A0A0A0A0A0A0A0A0A");let r=CryptoJS.enc.Hex.parse("647A797964730A0A0A0A0A0A0A0A0A0A");let l=CryptoJS.AES.decrypt({ciphertext:CryptoJS.enc.Base64.parse(e)},t,{iv:r,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8);return l}let o=false;function s(e){if(o){log(e)}}let n=[e=>{try{return ungzip(e)}catch(e){s("非gzip加密");return""}},e=>{try{return base64Decode(e)}catch(e){s("非b64加密");return""}},e=>{try{return i(e)}catch(e){s("非aes加密");return""}},e=>{try{return RSA.decode(e,r,null)}catch(e){s("非rsa加密");return""}}];let a=0;while(!t.test(l)){l=n[a](e);a++;if(a>=n.length){break}}return l}function runMain(main_func_code,arg){let mainFunc=function(){return""};try{eval(main_func_code+"\nmainFunc=main;");return mainFunc(arg)}catch(e){log(`执行main_funct发生了错误:${e.message}`);return""}}function init(ext){console.log("init");rule={};rule_fetch_params={};fetch_params=null;try{let muban=模板.getMubans();if(typeof ext=="object"){rule=ext}else if(typeof ext=="string"){let is_file=ext.startsWith("file://");if(ext.startsWith("http")||is_file){let query=getQuery(ext);if(is_file){ext=ext.split("?")[0]}let js=request(ext,{method:"GET"});if(js){js=getOriginalJs(js);eval("(function(){"+js.replace("var rule","rule")+"})()")}if(query.type==="url"&&query.params){if(is_file&&/^http/.test(query.params)){rule.params=query.params}else{rule.params=urljoin(ext,query.params)}}else if(query.params){rule.params=query.params}}else{ext=getOriginalJs(ext);eval("(function(){"+ext.replace("var rule","rule")+"})()")}}else{console.log(`规则加载失败,不支持的规则类型:${typeof ext}`);return}rule.host=(rule.host||"").rstrip("/");HOST=rule.host;if(rule.hostJs){console.log(`检测到hostJs,准备执行...`);try{eval(rule.hostJs);rule.host=HOST.rstrip("/")}catch(e){console.log(`执行${rule.hostJs}获取host发生错误:${e.message}`)}}if(rule["模板"]==="自动"){try{let host_headers=rule["headers"]||{};let host_html=getCode(HOST,{headers:host_headers});let match_muban="";let muban_keys=Object.keys(muban).filter(e=>!/默认|短视2|采集1/.test(e));for(let muban_key of muban_keys){try{let host_data=JSON.parse(home({},host_html,muban[muban_key].class_parse));if(host_data.class&&host_data.class.length>0){match_muban=muban_key;console.log(`自动匹配模板:【${muban_key}】`);break}}catch(e){console.log(`自动匹配模板:【${muban_key}】错误:${e.message}`)}}if(match_muban){muban["自动"]=muban[match_muban];if(rule["模板修改"]&&rule["模板修改"].startsWith("js:")){eval(rule["模板修改"].replace("js:","").trim())}}else{delete rule["模板"]}}catch(e){delete rule["模板"]}}if(rule.模板&&muban.hasOwnProperty(rule.模板)){print("继承模板:"+rule.模板);rule=Object.assign(muban[rule.模板],rule)}let rule_cate_excludes=(rule.cate_exclude||"").split("|").filter(e=>e.trim());let rule_tab_excludes=(rule.tab_exclude||"").split("|").filter(e=>e.trim());rule_cate_excludes=rule_cate_excludes.concat(CATE_EXCLUDE.split("|").filter(e=>e.trim()));rule_tab_excludes=rule_tab_excludes.concat(TAB_EXCLUDE.split("|").filter(e=>e.trim()));rule.cate_exclude=rule_cate_excludes.join("|");rule.tab_exclude=rule_tab_excludes.join("|");rule.类型=rule.类型||"影视";rule.url=rule.url||"";rule.double=rule.double||false;rule.homeUrl=rule.homeUrl||"";rule.detailUrl=rule.detailUrl||"";rule.searchUrl=rule.searchUrl||"";rule.homeUrl=rule.host&&rule.homeUrl?urljoin(rule.host,rule.homeUrl):rule.homeUrl||rule.host;rule.homeUrl=cheerio.jinja2(rule.homeUrl,{rule:rule});rule.detailUrl=rule.host&&rule.detailUrl?urljoin(rule.host,rule.detailUrl):rule.detailUrl;rule.二级访问前=rule.二级访问前||"";if(rule.url.includes("[")&&rule.url.includes("]")){let u1=rule.url.split("[")[0];let u2=rule.url.split("[")[1].split("]")[0];rule.url=rule.host&&rule.url?urljoin(rule.host,u1)+"["+urljoin(rule.host,u2)+"]":rule.url}else{rule.url=rule.host&&rule.url?urljoin(rule.host,rule.url):rule.url}if(rule.searchUrl.includes("[")&&rule.searchUrl.includes("]")&&!rule.searchUrl.includes("#")){let u1=rule.searchUrl.split("[")[0];let u2=rule.searchUrl.split("[")[1].split("]")[0];rule.searchUrl=rule.host&&rule.searchUrl?urljoin(rule.host,u1)+"["+urljoin(rule.host,u2)+"]":rule.searchUrl}else{rule.searchUrl=rule.host&&rule.searchUrl?urljoin(rule.host,rule.searchUrl):rule.searchUrl}rule.timeout=rule.timeout||5e3;rule.encoding=rule.编码||rule.encoding||"utf-8";rule.search_encoding=rule.搜索编码||rule.search_encoding||"";rule.图片来源=rule.图片来源||"";rule.图片替换=rule.图片替换||"";rule.play_json=rule.hasOwnProperty("play_json")?rule.play_json:[];rule.pagecount=rule.hasOwnProperty("pagecount")?rule.pagecount:{};rule.proxy_rule=rule.hasOwnProperty("proxy_rule")?rule.proxy_rule:"";if(!rule.hasOwnProperty("sniffer")){rule.sniffer=false}rule.sniffer=rule.hasOwnProperty("sniffer")?rule.sniffer:"";rule.sniffer=!!(rule.sniffer&&rule.sniffer!=="0"&&rule.sniffer!=="false");rule.isVideo=rule.hasOwnProperty("isVideo")?rule.isVideo:"";if(rule.sniffer&&!rule.isVideo){rule.isVideo="http((?!http).){12,}?\\.(m3u8|mp4|flv|avi|mkv|rm|wmv|mpg|m4a|mp3)\\?.*|http((?!http).){12,}\\.(m3u8|mp4|flv|avi|mkv|rm|wmv|mpg|m4a|mp3)|http((?!http).)*?video/tos*|http((?!http).)*?obj/tos*"}rule.tab_remove=rule.hasOwnProperty("tab_remove")?rule.tab_remove:[];rule.tab_order=rule.hasOwnProperty("tab_order")?rule.tab_order:[];rule.tab_rename=rule.hasOwnProperty("tab_rename")?rule.tab_rename:{};if(rule.headers&&typeof rule.headers==="object"){try{let header_keys=Object.keys(rule.headers);for(let k of header_keys){if(k.toLowerCase()==="user-agent"){let v=rule.headers[k];console.log(v);if(["MOBILE_UA","PC_UA","UC_UA","IOS_UA","UA"].includes(v)){rule.headers[k]=eval(v)}}else if(k.toLowerCase()==="cookie"){let v=rule.headers[k];if(v&&v.startsWith("http")){console.log(v);try{v=fetch(v);console.log(v);rule.headers[k]=v}catch(e){console.log(`从${v}获取cookie发生错误:${e.message}`)}}}}}catch(e){console.log(`处理headers发生错误:${e.message}`)}}else{rule.headers={}}oheaders=deepCopy(rule.headers);rule_fetch_params={headers:rule.headers,timeout:rule.timeout,encoding:rule.encoding};RKEY=typeof key!=="undefined"&&key?key:"drpy_"+(rule.title||rule.host);pre();init_test()}catch(e){console.log(`init_test发生错误:${e.message}`)}}let homeHtmlCache=undefined;function home(e,t,r){console.log("home");t=t||"";r=r||"";if(typeof rule.filter==="string"&&rule.filter.trim().length>0){try{let e=ungzip(rule.filter.trim());rule.filter=JSON.parse(e)}catch(e){rule.filter={}}}let l={filter:rule.filter||false,MY_URL:rule.homeUrl,class_name:rule.class_name||"",class_url:rule.class_url||"",class_parse:r||rule.class_parse||"",cate_exclude:rule.cate_exclude,home_html:t};return homeParse(l)}function homeVod(e){console.log("homeVod");let t={"推荐":rule.推荐,double:rule.double,homeUrl:rule.homeUrl,detailUrl:rule.detailUrl};return homeVodParse(t)}function category(e,t,r,l){let i={url:rule.url,"一级":rule.一级,tid:e,pg:parseInt(t),filter:r,extend:l};return categoryParse(i)}function detail(t){let e=t;let r="";log("orId:"+e);if(t.indexOf("$")>-1){let e=t.split("$");r=e[0];t=e[1]}let l=t.split("@@")[0];let i;if(!l.startsWith("http")&&!l.includes("/")){i=rule.detailUrl.replaceAll("fyid",l).replaceAll("fyclass",r)}else if(l.includes("/")){i=urljoin(rule.homeUrl,l)}else{i=l}let o={orId:e,url:i,"二级":rule.二级,"二级访问前":rule.二级访问前,detailUrl:l,fyclass:r,tab_exclude:rule.tab_exclude};return detailParse(o)}function play(e,t,r){let l={url:t,flag:e,flags:r};return playParse(l)}function search(e,t,r){if(rule.search_encoding){if(rule.search_encoding.toLowerCase()!=="utf-8"){e=encodeStr(e,rule.search_encoding)}}else if(rule.encoding&&rule.encoding.toLowerCase()!=="utf-8"){e=encodeStr(e,rule.encoding)}let l={searchUrl:rule.searchUrl,"搜索":rule.搜索,wd:e,pg:r||1,quick:t};return searchParse(l)}function proxy(e){if(rule.proxy_rule&&rule.proxy_rule.trim()){rule.proxy_rule=rule.proxy_rule.trim()}if(rule.proxy_rule.startsWith("js:")){rule.proxy_rule=rule.proxy_rule.replace("js:","")}let t={params:e,proxy_rule:rule.proxy_rule};return proxyParse(t)}function sniffer(){let e=rule.sniffer||false;if(e){log("开始执行辅助嗅探代理规则...")}return e}function isVideo(e){let t=0;let r;if(rule.isVideo&&rule.isVideo.trim()){r=rule.isVideo.trim()}if(r.startsWith("js:")){r=r.replace("js:","");t=1}let l={url:e,isVideo:r,t:t};let i=isVideoParse(l);if(i){log("成功执行辅助嗅探规则并检测到视频地址:\n"+rule.isVideo)}return i}function getRule(e){return e?rule[e]||"":rule}function deepCopy(e){return JSON.parse(JSON.stringify(e))}function matchesAll(e,t,r){if(!t.global){t=new RegExp(t.source,"g"+(t.ignoreCase?"i":"")+(t.multiline?"m":""))}var l=[];var i;while((i=t.exec(e))!==null){l.push(i)}return r?l.flat():l}function stringUtils(){Object.defineProperties(String.prototype,{replaceX:{value:function(t,r){let e=matchesAll(this,t,true);if(e&&e.length>1){const l=/\$\d/.test(r);if(l){return this.replace(t,e=>e.replace(t,r))}else{return this.replace(t,(e,t)=>e.replace(t,r))}}return this.replace(t,r)},configurable:true,enumerable:false,writable:true},parseX:{get:function(){try{return JSON.parse(this)}catch(e){console.log(e.message);return this.startsWith("[")?[]:{}}},configurable:true,enumerable:false}})}function cut(e,t,r,l,n){let i="";let o=(l,i,o)=>{let e="";let t=[];let r=[];try{let e=new RegExp(String.raw`${i}`.toString());let r=new RegExp(String.raw`${o}`.toString());const s=l.split(e);if(s.length<2)return"";let t=s.slice(1).map(e=>{let t=e.split(r);return t.length<2?undefined:t[0]+o}).filter(e=>e);if(n){return`[${t.join(",")}]`}else{return t[0]}}catch(o){console.log(`Error cutting text:${o.message}`)}return e};i=o(e,t,r);stringUtils();if(l&&typeof l==="function"){i=l(i)}return i}function DRPY(){return{runMain:runMain,getRule:getRule,init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,search:search,proxy:proxy,sniffer:sniffer,isVideo:isVideo,fixAdM3u8Ai:fixAdM3u8Ai}}export default{runMain:runMain,getRule:getRule,init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,search:search,proxy:proxy,sniffer:sniffer,isVideo:isVideo,fixAdM3u8Ai:fixAdM3u8Ai,DRPY:DRPY};